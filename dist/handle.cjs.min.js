"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var merge=_interopDefault(require("merge")),path=_interopDefault(require("path")),chalk=_interopDefault(require("chalk")),escapeStringRegexp=_interopDefault(require("escape-string-regexp")),glob=_interopDefault(require("glob")),Mock=_interopDefault(require("mockjs"));const PATTERN_IDENTIFIER=/[A-Za-z_][A-Za-z0-9_]*/;let requestMethods=["get","head","put","delete","post","options"],isObj=e=>"[object Object]"===Object.prototype.toString.call(e),noop=()=>{},error=(e,t="")=>{console.error(chalk.bgRed(" ERROR ")+" "+chalk.red(e)+(t?" ☞ "+chalk.gray(t):"")),process.exit(1)},load=(e,t,r)=>{"string"!=typeof t&&error("dir must be a string.","load(sequelize, →dir←, options)");try{return new Handle(e.import(t),r)}catch(e){1===load.length&&error("You may not have passed in the Sequelie instance, it imports the model using import."),error(e)}},loadAll=function(e,t,r={}){"string"!=typeof t&&error("dir must be a string.","load(sequelize, →dir←, options)");const{rule:n="/**/!(index|_)*.js"}=r;return glob.sync(path.join(t,n)).reduce((t,n)=>{const o=path.parse(n).name;return t[o]=this.load(e,n,r),t["_"+o]=t[o].model,t},{})},getOp=(e,t)=>{if("string"==typeof e)e=[e];else if("function"==typeof e)return e(t);return Array.isArray(e)?{where:e.reduce((e,r)=>("string"==typeof r?parseSign(r,"@"+r,e,t):Array.isArray(r)&&parseSign(r[0],r[1],e,t),e),{})}:e||{}},getRequestData=(e,t)=>"get"===(e=e.toLowerCase())?t.query:"post"===e?t.request.body:{},mixinScope=(e,t,r,n)=>{let o=r.concat(n);if(!o.length)return t;let i=o.map(t=>{if(isObj(t))return t;let r=t(e);return r="function"==typeof r?t()(e):t(e)});return merge.recursive(!0,t,...i)},initialCap=e=>e[0].toUpperCase()+e.substring(1),tailspin=(e,t,r)=>{const n=t.match(/[^\.\[\]]+/g);if(n)try{return n.map(e=>Object.is(Number(e),NaN)?e:Number(e)).reduce((e,t)=>e[t],e)||r}catch(e){return r}return r},proxyNames={get:["findOne","findAll","findById","findOrCreate","findAndCountAll","findAndCount","findCreateFind","count","max","min","sun"],post:["create","bulkCreate","update","destroy","increment","decrement"]};function parseSign(e,t,r,n){"function"==typeof t&&(t=t(n));let o=e.match(PATTERN_IDENTIFIER),i=o,a=t;if(o=o&&o[0],"string"==typeof t&&/^@/.test(t)&&(a=n[i=t.match(PATTERN_IDENTIFIER)[0]]),/^!/.test(e)&&null==n[i])return;let s={">":"gt",">=":"gte","<":"lt","<=":"lte","!=":"ne","=":"and",$and:"and",$or:"or",$gt:"gt",$gte:"gte",$lt:"lt",$lte:"lte",$ne:"ne",$eq:"eq",$not:"not",$between:"between",$notBetween:"notBetween",$in:"in",$notIn:"notIn",$like:"like",$notLike:"notLike",$iLike:"iLike",$regexp:"regexp",$iRegexp:"iRegexp",$notIRegexp:"notIRegexp",$overlap:"overlap",$contains:"contains",$contained:"contained",$any:"any",$col:"col"},l=e.match(new RegExp("("+Object.keys(s).map(e=>escapeStringRegexp(e)).join("|")+")")),c=s[l?l[0]:"="];"and"===c?(r[o]||(r[o]=[]),r[o]=a):(r[o]||(r[o]={}),r[o][c]=a)}const maps={};function add(e,t){return"function"!=typeof t&&(t=(()=>t)),maps[e]=t.bind(maps),this}function remove(e){return delete maps[e]}function get(e){return maps[e]}function create(...e){return function e(t,r=[]){for(let n in t){let o=t[n];if("string"==typeof o)r.push(maps[o]());else if(Array.isArray(o))e(o,r);else{let[t,n]=Object.entries(o)[0],i=maps[t]();i.include=[],r.push(i),e(n,i.include)}}return{include:r}}(e)}var Include={add:add,remove:remove,get:get,create:create};let where=(...e)=>t=>getOp(e,t),pagination=(e=5,t=0)=>r=>{const n=~~r.count||e;return{limit:n,offset:(~~r.page||t)*n}},fuzzyQuery=(e="name")=>where([`${e} $like`,t=>`%${t[e]}%`]),fuzzyQueryLeft=(e="name")=>where([`${e} $like`,t=>`%${t[e]}`]),fuzzyQueryRight=(e="name")=>where([`${e} $like`,t=>`${t[e]}%`]),include=(...e)=>t=>({include:e}),order=(...e)=>t=>({order:e}),remove$1=(...e)=>t=>(e.forEach(e=>{e in t&&delete t[e]}),{}),set=(e,t)=>r=>(r[e]=t,{}),merge$1=(...e)=>t=>merge.recursive(!0,{},...e.map(e=>"function"==typeof e?e(t):e));function wrapper(e){return Array.isArray(e)?e:[e]}let it=(e,t,r=noop)=>n=>("boolean"==typeof e?e:"function"==typeof e?e(n):n[e])?merge$1(...wrapper(t))(n):merge$1(...wrapper(r))(n),not=(e,t,r=noop)=>it(e,r,t),itField=(e,t)=>r=>{const n=r[e];return it(!0,t[n])(r)};var Scopes={where:where,fuzzyQuery:fuzzyQuery,fuzzyQueryLeft:fuzzyQueryLeft,fuzzyQueryRight:fuzzyQueryRight,include:include,order:order,pagination:pagination,remove:remove$1,set:set,it:it,itField:itField,not:not,merge:merge$1};function Handle(e,t={}){if(!(this instanceof Handle))return new Handle(e,t={});this.model=e,this.options=t,this.defaultScopes=[],this._data=null,this.__reset()}function method(e="get"){return e=e.toLowerCase(),requestMethods.includes(e)||error("Only the http standard request method is supported ("+requestMethods.join("/")+")",e),this._opts.method=e,this}function raw(e){return this._opts.rawData=e,this}function scope(...e){return e.forEach(e=>{isObj(e)||"function"==typeof e||error("Scope must be a function or object.",`${this.model.name}.scope(→...scopes←)`),this._opts.scopes.push(e)}),this}function defaultScope(...e){return e.forEach(e=>{isObj(e)||"function"==typeof e||error("Scope must be a function or object.",`${this.model.name}.scope(→...scopes←)`),this.defaultScopes.push(e)}),this}function rawScope(...e){return new Handle(this.model.scope(...e),this.options)}function process$1(e,t){return"function"==typeof e&&([t,e]=[e,"get"]),requestMethods.includes(e)||error("Only the http standard request method is supported ("+requestMethods.join("/")+")",e),async(r,n)=>{let o=getRequestData(e,r);try{o=this.__callHook("before",o,r,n),this._data=o;let e=await t.call(this,o,r,n);return this._data=null,e=this.__callHook("after",e,r,n),r.body=this.__callHook("data",null,e,r,n)}catch(e){return r.body=this.__callHook("data",e,null,r,n)}}}function transaction(e,t){return this.process(e,async function(e,r,n){return await this.model.sequelize.transaction(o=>t.call(this,e,r,n,o))})}function mock(e,t){return isObj(e)&&([e,t]=[1,e]),this.raw(Mock.mock({[`data|${e}`]:[t]}).data).bulkCreate()}function __internal(e,...t){let{defaultScopes:r}=this,{method:n,rawData:o,scopes:i}=this.__reset();return async(a,s)=>{const l=n||tailspin(this,`options.proxy.${e}.method`)||tailspin(Handle,`defaults.proxy.${e}.method`)||"get";let c=getRequestData(l,a);try{c=this.__callHook("before",c,a,s);let n=getOp(t,c);n=mixinScope(c,n,r,i),o&&(c="function"==typeof o?o(c):o),n=[c,n].slice(-this.model[e].length);let l=await this.model[e](...n);return l=this.__callHook("after",l,a,s),a.body=this.__callHook("data",null,l,a,s)}catch(e){return a.body=this.__callHook("data",e,a,s)}}}async function __process(e,...t){let{defaultScopes:r}=this,{rawData:n,scopes:o}=this.__reset(),i=this._data,a=getOp(t,i);return a=mixinScope(i,a,r,o),n&&(i="function"==typeof n?n(i):n),console.log(a),a=[i,a].slice(-this.model[e].length),await this.model[e](...a)}function __reset(){let e=this._opts;return this._opts={scopes:[]},e&&(e=merge.recursive(!0,{},e)),e}function __callHook(e,...t){const r=this.options[e];return r&&"function"==typeof r?r(...t):3===t.length?t[0]:t[1]}Handle.prototype={constructor:Handle,method:method,raw:raw,scope:scope,defaultScope:defaultScope,rawScope:rawScope,process:process$1,transaction:transaction,mock:mock,__internal:__internal,__process:__process,__reset:__reset,__callHook:__callHook},Handle.defaults={proxy:{}};for(let e in proxyNames){proxyNames[e].forEach(t=>{Handle.defaults.proxy[t]={method:e},Handle.prototype[t]=function(...e){return this.__internal(t,...e)},Handle.prototype["raw"+initialCap(t)]=function(...e){return this.__process(t,...e)}})}Handle.load=load,Handle.loadAll=loadAll,Handle.Include=Include,Handle.Scopes=Scopes,module.exports=Handle;
