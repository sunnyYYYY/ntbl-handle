"use strict";function _interopDefault(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var merge=_interopDefault(require("merge"));let getOp=(t,e,n,s)=>("string"==typeof t&&(t=[t]),Array.isArray(t)?{where:t.reduce((t,n)=>("string"==typeof n&&(t[n]=e[n]),Array.isArray(n)&&(t[n[0]]=/^@/.test(n[1])?e[n[1].slice(1)]:n[1]),t),{})}:"function"==typeof t?t(e,n,s):t||{}),getRequestData=(t,e)=>"get"===t?e.query:"post"===t?e.request.body:{},mixinScope=(t,e,n,s)=>{let r=n.concat(s);if(!r.length)return e;let a=r.map(e=>{let n="function"==typeof e?e(t):e;return"function"==typeof n&&(n=e()(t)),n});return merge.recursive(!0,e,...a)},getProxyFunNames={get:["findOne","findAll","findById","findOrCreate","findAndCountAll","findAndCount","findCreateFind","count","max","min","sun"],post:["create","bulkCreate","update","destroy","increment","decrement"]};class Include{constructor(){this.__maps={}}add(t,e){const n=this.__maps;return"function"!=typeof e&&(e=(()=>e)),n[t]=e.bind(n),this}remove(t){return delete this.__maps[t]}get(t){return this.__maps[t]}create(...t){const e=this.__maps;return function t(n,s=[]){for(let r in n){let a=n[r];if("string"==typeof a)s.push(e[a]());else if(Array.isArray(a))t(a,s);else{let[n,r]=Object.entries(a)[0],o=e[n]();o.include=[],s.push(o),t(r,o.include)}}return s}(t)}}class Base{toggle(t,e,n){}findOne(t,e,n){}findAll(t,e,n){}findById(t,e,n){}findOrCreate(t,e,n){}findAndCountAll(t,e,n){}findAndCount(t,e,n){}findCreateFind(t,e,n){}count(t,e,n){}max(t,e,n){}min(t,e,n){}sun(t,e,n){}create(t,e,n){}bulkCreate(t,e,n){}update(t,e,n){}destroy(t,e,n){}increment(t,e,n){}decrement(t,e,n){}rawFindOne(t){}rawFindAll(t){}rawFindById(t){}rawFindOrCreate(t){}rawFindAndCountAll(t){}rawFindAndCount(t){}rawFindCreateFind(t){}rawCount(t){}rawMax(t){}rawMin(t){}rawSun(t){}rawCreate(t){}rawBulkCreate(t){}rawUpdate(t){}rawDestroy(t){}rawIncrement(t){}rawDecrement(t){}}class Handle extends Base{constructor(t,e={}){super(),this.model=t,this.options=e,this._defaultScopes=[],this._scopes=[],this._data={},this.__init(getProxyFunNames)}defaultScope(...t){return t.forEach(t=>this._defaultScopes.push(t)),this}scope(...t){return this._scopes=[],t.forEach(t=>this._scopes.push(t)),this}rawScope(...t){return new Handle(this.model.scope(...t),this.options)}process(t,e){"function"==typeof t&&(e=t,t="get");const{before:n,after:s,data:r}=this.options;return async(a,o)=>{let i=getRequestData(t,a);try{n&&n(i,a,o),this._data=i;let t=await e.call(this,i,a,o);return this._data={},s&&(t=s(t,a,o)),a.body=r(void 0,t,a,o)}catch(t){return a.body=r(t,null,a,o)}}}toggle(...t){return async(e,n)=>{await this.__base("post","findOne",...t)(e,n)?await this.__base("post","destroy",...t)(e,n):await this.__base("post","create",...t)(e,n)}}transaction(t,e){return this.process(t,async function(t,n,s){return await sequelize.transaction(r=>e.call(this,t,n,s,r))})}mock(t){const e=this.options.mock;if(!e)throw new Error("Handle.prototype.mock 方法依赖 mock 库，推荐使用 mockjs\n npm install mockjs --save\n 然后，在 Handle.options.mock = Mock 使用指定的 mock 库");return this.bulkCreate({},n=>e.mock(t).data)}__init(t){for(let e in t)t[e].forEach(t=>{Handle.prototype[t]=function(...n){const s=this._scopes;return this._scopes=[],this.__base(e,t,s,...n)};const n="raw"+t[0].toUpperCase()+t.substring(1);Handle.prototype[n]=function(...e){const n=this._scopes;return this._scopes=[],this.__processBase(t,n,...e)}})}__base(t,e,n,s,r,a){const{before:o,after:i,data:c}=this.options;return async(u,d)=>{let l=getRequestData(t,u);try{o&&(l=o(l,u,d)),r&&(l=r(l,u,d)),console.log("data ->",l);let t=getOp(s,l,u,d);t=mixinScope(l,t,this._defaultScopes,n);const p=this.model[e];let f=p.length;t=1===f?[t]:2===f?[l,t]:[];let h=await p.apply(this.model,t);return i&&(h=i(h,u,d)),a&&(h=a(h,u,d)),u.body=c(void 0,h,u,d)}catch(t){return u.body=c(t,null,u,d)}}}async __processBase(t,e,n,s){s||(s=n,n=null);const r=this._data;let a=getOp(s,r);return a=mixinScope(r,a,this._defaultScopes,e),console.log(a),a=n?[n,a]:[a],await this.model[t](...a)}}Handle.Include=new Include,module.exports=Handle;
