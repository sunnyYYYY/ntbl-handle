"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var merge=_interopDefault(require("merge")),path=_interopDefault(require("path")),chalk=_interopDefault(require("chalk")),escapeStringRegexp=_interopDefault(require("escape-string-regexp")),glob=_interopDefault(require("glob"));const PATTERN_IDENTIFIER=/[A-Za-z_][A-Za-z0-9_]*/;let requestMethods=["get","head","put","delete","post","options"],isObj=e=>"[object Object]"===Object.prototype.toString.call(e),error=(e,t="")=>{console.error(chalk.bgRed(" ERROR ")+" "+chalk.red(e)+(t?" ☞ "+chalk.gray(t):"")),process.exit(1)},load=(e,t,o)=>{"string"!=typeof t&&error("dir must be a string.","load(sequelize, →dir←, options)");try{return new Handle(e.import(t),o)}catch(e){1===load.length&&error("You may not have passed in the Sequelie instance, it imports the model using import."),error("Please check the path, it may be wrong.",t)}},loadAll=function(e,t,o={}){"string"!=typeof t&&error("dir must be a string.","load(sequelize, →dir←, options)");const{rule:n="/**/!(index|_)*.js"}=o;return glob.sync(path.join(t,n)).reduce((t,n)=>(t[path.parse(n).name]=this.load(e,n,o),t),{})},getOp=(e,t)=>{if("string"==typeof e)e=[e];else if("function"==typeof e)return e(t);return Array.isArray(e)?{where:e.reduce((e,o)=>("string"==typeof o?parseSign(o,"@"+o,e,t):Array.isArray(o)&&parseSign(o[0],o[1],e,t),e),{})}:e||{}},getRequestData=(e,t)=>"get"===(e=e.toLowerCase())?t.query:"post"===e?t.request.body:{},mixinScope=(e,t,o,n)=>{let r=o.concat(n);if(!r.length)return t;let i=r.map(t=>{if(isObj(t))return t;let o=t(e);return o="function"==typeof o?t()(e):t(e)});return merge.recursive(!0,t,...i)},initialCap=e=>e[0].toUpperCase()+e.substring(1),proxyNames={get:["findOne","findAll","findById","findOrCreate","findAndCountAll","findAndCount","findCreateFind","count","max","min","sun"],post:["create","bulkCreate","update","destroy","increment","decrement"]};function parseSign(e,t,o,n){"function"==typeof t&&(t=t(n));let r=e.match(PATTERN_IDENTIFIER),i=r,s=t;if(r=r&&r[0],"string"==typeof t&&/^@/.test(t)&&(s=n[i=t.match(PATTERN_IDENTIFIER)[0]]),/^!/.test(e)&&null==n[i])return;let a={">":"gt",">=":"gte","<":"lt","<=":"lte","!=":"ne","=":"and",$and:"and",$or:"or",$gt:"gt",$gte:"gte",$lt:"lt",$lte:"lte",$ne:"ne",$eq:"eq",$not:"not",$between:"between",$notBetween:"notBetween",$in:"in",$notIn:"notIn",$like:"like",$notLike:"notLike",$iLike:"iLike",$regexp:"regexp",$iRegexp:"iRegexp",$notIRegexp:"notIRegexp",$overlap:"overlap",$contains:"contains",$contained:"contained",$any:"any",$col:"col"},l=e.match(new RegExp("("+Object.keys(a).map(e=>escapeStringRegexp(e)).join("|")+")")),c=a[l?l[0]:"="];"and"===c?(o[r]||(o[r]=[]),o[r]=s):(o[r]||(o[r]={}),o[r][c]=s)}class Include{constructor(){this.__maps={}}add(e,t){const o=this.__maps;return"function"!=typeof t&&(t=(()=>t)),o[e]=t.bind(o),this}remove(e){return delete this.__maps[e]}get(e){return this.__maps[e]}create(...e){const t=this.__maps;return function e(o,n=[]){for(let r in o){let i=o[r];if("string"==typeof i)n.push(t[i]());else if(Array.isArray(i))e(i,n);else{let[o,r]=Object.entries(i)[0],s=t[o]();s.include=[],n.push(s),e(r,s.include)}}return{include:n}}(e)}}let where=(...e)=>t=>getOp(e,t),pagination=(e=5,t=0)=>o=>{const n=~~o.count||e;return{limit:n,offset:(~~o.page||t)*n}},fuzzyQuery=(e="name")=>where([`${e} $like`,t=>`%${t[e]}%`]),fuzzyQueryLeft=(e="name")=>where([`${e} $like`,t=>`%${t[e]}`]),fuzzyQueryRight=(e="name")=>where([`${e} $like`,t=>`${t[e]}%`]);var Scopes={where:where,fuzzyQuery:fuzzyQuery,fuzzyQueryLeft:fuzzyQueryLeft,fuzzyQueryRight:fuzzyQueryRight,pagination:pagination};function Handle(e,t={}){if(!(this instanceof Handle))return new Handle(e,t={});this.model=e,this.options=t,this._scopes=[],this._defaultScopes=[],this._data=null,this._method=null}function method(e){return e=e.toLowerCase(),requestMethods.includes(e)||error("Only the http standard request method is supported ("+requestMethods.join("/")+")",e),this._method=e,this}function scope(...e){return this.__clearScope(),e.forEach(e=>{isObj(e)||"function"==typeof e||error("Scope must be a function or object.",`${this.model.name}.scope(→...scopes←)`),this._scopes.push(e)}),this}function __clearScope(){const e=this._scopes;return this._scopes=[],e}function defaultScope(...e){return e.forEach(e=>{isObj(e)||"function"==typeof e||error("Scope must be a function or object.",`${this.model.name}.scope(→...scopes←)`),this._defaultScopes.push(e)}),this}function rawScope(...e){return new Handle(this.model.scope(...e),this.options)}function process$1(e,t){return requestMethods.includes(e)||error("Only the http standard request method is supported ("+requestMethods.join("/")+")",e),this.mode=!0,"function"==typeof e&&([t,e]=[e,"get"]),async(o,n)=>{let r=getRequestData(e,o);try{r=this.__callHook("before",r,o,n),this._data=r;let e=await t.call(this,r,o,n);return this._data=null,e=this.__callHook("after",e,o,n),o.body=this.__callHook("data",null,e,o,n)}catch(e){return o.body=this.__callHook("data",e,null,o,n)}}}function transaction(e,t){return this.process(e,async function(e,o,n){return await this.model.sequelize.transaction(r=>t.call(this,e,o,n,r))})}function mock(e){const t=this.options.mock;return t||error("Handle.prototype.mock 方法依赖 mock 库，推荐使用 mockjs\n npm install mockjs --save\n 然后，在 Handle.options.mock = Mock 使用指定的 mock 库"),this.bulkCreate(t.mock(e).data,{})}function __internal(e,t,...o){return async(n,r)=>{const i=this._method||this.options.proxy&&this.options.proxy[e]&&this.options.proxy[e].method||Handle.defaults.proxy[e].method||"get";let s=getRequestData(i,n);this._method=null;try{s=this.__callHook("before",s,n,r);let i=getOp(o,s);i=[s,i=mixinScope(s,i,this._defaultScopes,t)].slice(-this.model[e].length);let a=await this.model[e](...i);return a=this.__callHook("after",a,n,r),n.body=this.__callHook("data",null,a,n,r)}catch(e){return n.body=this.__callHook("data",e,n,r)}}}async function __process(e,t,...o){let n=this._data,r=getOp(o,n);return r=[n,r=mixinScope(n,r,this._defaultScopes,t)].slice(-this.model[e].length),await this.model[e](...r)}function __callHook(e,...t){const o=this.options[e];return o&&"function"==typeof o?o(...t):3===t.length?t[0]:t[1]}Handle.prototype={constructor:Handle,scope:scope,defaultScope:defaultScope,rawScope:rawScope,process:process$1,transaction:transaction,mock:mock,method:method,__clearScope:__clearScope,__internal:__internal,__process:__process,__callHook:__callHook},Handle.defaults={proxy:{}};for(let e in proxyNames){proxyNames[e].forEach(t=>{Handle.defaults.proxy[t]={method:e},Handle.prototype[t]=function(...e){return this.__internal(t,this.__clearScope(),...e)},Handle.prototype["raw"+initialCap(t)]=function(...e){return this.__process(t,this.__clearScope(),...e)}})}Handle.load=load,Handle.loadAll=loadAll,Handle.Include=new Include,Handle.Scopes=Scopes,module.exports=Handle;
