"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var merge=_interopDefault(require("merge")),path=_interopDefault(require("path")),chalk=_interopDefault(require("chalk")),escapeStringRegexp=_interopDefault(require("escape-string-regexp")),glob=_interopDefault(require("glob"));const PATTERN_IDENTIFIER=/[A-Za-z_][A-Za-z0-9_]*/;let requestMethods=["get","head","put","delete","post","options"],isObj=e=>"[object Object]"===Object.prototype.toString.call(e),error=(e,t="")=>{console.error(chalk.bgRed(" ERROR ")+" "+chalk.red(e)+(t?" ☞ "+chalk.gray(t):"")),process.exit(1)},load=(e,t,n)=>{"string"!=typeof t&&error("dir must be a string.","load(sequelize, →dir←, options)");try{return new Handle(e.import(t),n)}catch(e){1===load.length&&error("You may not have passed in the Sequelie instance, it imports the model using import."),error("Please check the path, it may be wrong.",t)}},loadAll=function(e,t,n={}){"string"!=typeof t&&error("dir must be a string.","load(sequelize, →dir←, options)");const{rule:o="/**/!(index|_)*.js"}=n;return glob.sync(path.join(t,o)).reduce((t,o)=>(t[path.parse(o).name]=this.load(e,o,n),t),{})},getOp=(e,t)=>{if("string"==typeof e)e=[e];else if("function"==typeof e)return e(t);return Array.isArray(e)?{where:e.reduce((e,n)=>("string"==typeof n?parseSign(n,"@"+n,e,t):Array.isArray(n)&&parseSign(n[0],n[1],e,t),e),{})}:e||{}},getRequestData=(e,t)=>"get"===(e=e.toLowerCase())?t.query:"post"===e?t.request.body:{},mixinScope=(e,t,n,o)=>{let r=n.concat(o);if(!r.length)return t;let i=r.map(t=>{if(isObj(t))return t;let n=t(e);return n="function"==typeof n?t()(e):t(e)});return merge.recursive(!0,t,...i)},initialCap=e=>e[0].toUpperCase()+e.substring(1),tailspin=(e,t,n)=>{const o=t.match(/[^\.\[\]]+/g);if(o)try{return o.map(e=>Object.is(Number(e),NaN)?e:Number(e)).reduce((e,t)=>e[t],e)||n}catch(e){return n}return n},proxyNames={get:["findOne","findAll","findById","findOrCreate","findAndCountAll","findAndCount","findCreateFind","count","max","min","sun"],post:["create","bulkCreate","update","destroy","increment","decrement"]};function parseSign(e,t,n,o){"function"==typeof t&&(t=t(o));let r=e.match(PATTERN_IDENTIFIER),i=r,a=t;if(r=r&&r[0],"string"==typeof t&&/^@/.test(t)&&(a=o[i=t.match(PATTERN_IDENTIFIER)[0]]),/^!/.test(e)&&null==o[i])return;let s={">":"gt",">=":"gte","<":"lt","<=":"lte","!=":"ne","=":"and",$and:"and",$or:"or",$gt:"gt",$gte:"gte",$lt:"lt",$lte:"lte",$ne:"ne",$eq:"eq",$not:"not",$between:"between",$notBetween:"notBetween",$in:"in",$notIn:"notIn",$like:"like",$notLike:"notLike",$iLike:"iLike",$regexp:"regexp",$iRegexp:"iRegexp",$notIRegexp:"notIRegexp",$overlap:"overlap",$contains:"contains",$contained:"contained",$any:"any",$col:"col"},l=e.match(new RegExp("("+Object.keys(s).map(e=>escapeStringRegexp(e)).join("|")+")")),c=s[l?l[0]:"="];"and"===c?(n[r]||(n[r]=[]),n[r]=a):(n[r]||(n[r]={}),n[r][c]=a)}const maps={};function add(e,t){return"function"!=typeof t&&(t=(()=>t)),maps[e]=t.bind(maps),this}function remove(e){return delete maps[e]}function get(e){return maps[e]}function create(...e){return function e(t,n=[]){for(let o in t){let r=t[o];if("string"==typeof r)n.push(maps[r]());else if(Array.isArray(r))e(r,n);else{let[t,o]=Object.entries(r)[0],i=maps[t]();i.include=[],n.push(i),e(o,i.include)}}return{include:n}}(e)}var Include={add:add,remove:remove,get:get,create:create};let where=(...e)=>t=>getOp(e,t),pagination=(e=5,t=0)=>n=>{const o=~~n.count||e;return{limit:o,offset:(~~n.page||t)*o}},fuzzyQuery=(e="name")=>where([`${e} $like`,t=>`%${t[e]}%`]),fuzzyQueryLeft=(e="name")=>where([`${e} $like`,t=>`%${t[e]}`]),fuzzyQueryRight=(e="name")=>where([`${e} $like`,t=>`${t[e]}%`]);var Scopes={where:where,fuzzyQuery:fuzzyQuery,fuzzyQueryLeft:fuzzyQueryLeft,fuzzyQueryRight:fuzzyQueryRight,pagination:pagination};function Handle(e,t={}){if(!(this instanceof Handle))return new Handle(e,t={});this.model=e,this.options=t,this.defaultScopes=[],this._data=null,this.__reset()}function method(e="get"){return e=e.toLowerCase(),requestMethods.includes(e)||error("Only the http standard request method is supported ("+requestMethods.join("/")+")",e),this._opts.method=e,this}function raw(e){return this._opts.rawData=e,this}function scope(...e){return e.forEach(e=>{isObj(e)||"function"==typeof e||error("Scope must be a function or object.",`${this.model.name}.scope(→...scopes←)`),this._opts.scopes.push(e)}),this}function defaultScope(...e){return e.forEach(e=>{isObj(e)||"function"==typeof e||error("Scope must be a function or object.",`${this.model.name}.scope(→...scopes←)`),this.defaultScopes.push(e)}),this}function rawScope(...e){return new Handle(this.model.scope(...e),this.options)}function process$1(e,t){return requestMethods.includes(e)||error("Only the http standard request method is supported ("+requestMethods.join("/")+")",e),this.mode=!0,"function"==typeof e&&([t,e]=[e,"get"]),async(n,o)=>{let r=getRequestData(e,n);try{r=this.__callHook("before",r,n,o),this._data=r;let e=await t.call(this,r,n,o);return this._data=null,e=this.__callHook("after",e,n,o),n.body=this.__callHook("data",null,e,n,o)}catch(e){return n.body=this.__callHook("data",e,null,n,o)}}}function transaction(e,t){return this.process(e,async function(e,n,o){return await this.model.sequelize.transaction(r=>t.call(this,e,n,o,r))})}function mock(e){const t=this.options.mock;return t||error("Handle.prototype.mock 方法依赖 mock 库，推荐使用 mockjs\n npm install mockjs --save\n 然后，在 Handle.options.mock = Mock 使用指定的 mock 库"),this.raw(t.mock(e).data).bulkCreate()}function __internal(e,...t){let{defaultScopes:n}=this,{method:o,rawData:r,scopes:i}=this.__reset();return async(a,s)=>{const l=o||tailspin(this,`options.proxy${e}.method`)||tailspin(Handle,`defaults.proxy${e}.method`)||"get";let c=getRequestData(l,a);try{c=this.__callHook("before",c,a,s);let o=getOp(t,c);o=mixinScope(c,o,n,i),r&&(c="function"==typeof r?r(c):r),o=[c,o].slice(-this.model[e].length);let l=await this.model[e](...o);return l=this.__callHook("after",l,a,s),a.body=this.__callHook("data",null,l,a,s)}catch(e){return a.body=this.__callHook("data",e,a,s)}}}async function __process(e,t,...n){let o=this._data,r=getOp(n,o);return r=[o,r=mixinScope(o,r,this.defaultScopes,t)].slice(-this.model[e].length),await this.model[e](...r)}function __reset(){let e=this._opts;return this._opts={scopes:[]},e&&(e=merge.recursive(!0,{},e)),e}function __callHook(e,...t){const n=this.options[e];return n&&"function"==typeof n?n(...t):3===t.length?t[0]:t[1]}Handle.prototype={constructor:Handle,method:method,raw:raw,scope:scope,defaultScope:defaultScope,rawScope:rawScope,process:process$1,transaction:transaction,mock:mock,__internal:__internal,__process:__process,__reset:__reset,__callHook:__callHook},Handle.defaults={proxy:{}};for(let e in proxyNames){proxyNames[e].forEach(t=>{Handle.defaults.proxy[t]={method:e},Handle.prototype[t]=function(...e){return this.__internal(t,...e)},Handle.prototype["raw"+initialCap(t)]=function(...e){return this.__process(t,...e)}})}Handle.load=load,Handle.loadAll=loadAll,Handle.Include=Include,Handle.Scopes=Scopes,module.exports=Handle;
