"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var merge=_interopDefault(require("merge")),path=_interopDefault(require("path")),chalk=_interopDefault(require("chalk")),escapeStringRegexp=_interopDefault(require("escape-string-regexp")),glob=_interopDefault(require("glob"));const PATTERN_IDENTIFIER=/[A-Za-z_][A-Za-z0-9_]*/;let requestMethods=["get","head","put","delete","post","options"],isObj=e=>"[object Object]"===Object.prototype.toString.call(e),noop=()=>{},error=(e,t="")=>{console.error(chalk.bgRed(" ERROR ")+" "+chalk.red(e)+(t?" ☞ "+chalk.gray(t):"")),process.exit(1)},load=(e,t,o)=>{"string"!=typeof t&&error("dir must be a string.","load(sequelize, →dir←, options)");try{return new Handle(e.import(t),o)}catch(e){1===load.length&&error("You may not have passed in the Sequelie instance, it imports the model using import."),error("Please check the path, it may be wrong.",t)}},loadAll=function(e,t,o={}){"string"!=typeof t&&error("dir must be a string.","load(sequelize, →dir←, options)");const{rule:n="/**/!(index|_)*.js"}=o;return glob.sync(path.join(t,n)).reduce((t,n)=>(t[path.parse(n).name]=this.load(e,n,o),t),{})},getOp=(e,t)=>{if("string"==typeof e)e=[e];else if("function"==typeof e)return e(t);return Array.isArray(e)?{where:e.reduce((e,o)=>("string"==typeof o?parseSign(o,"@"+o,e,t):Array.isArray(o)&&parseSign(o[0],o[1],e,t),e),{})}:e||{}},getRequestData=(e,t)=>"get"===(e=e.toLowerCase())?t.query:"post"===e?t.request.body:{},mixinScope=(e,t,o,n)=>{let r=o.concat(n);if(!r.length)return t;let i=r.map(t=>{if(isObj(t))return t;let o=t(e);return o="function"==typeof o?t()(e):t(e)});return merge.recursive(!0,t,...i)},initialCap=e=>e[0].toUpperCase()+e.substring(1),tailspin=(e,t,o)=>{const n=t.match(/[^\.\[\]]+/g);if(n)try{return n.map(e=>Object.is(Number(e),NaN)?e:Number(e)).reduce((e,t)=>e[t],e)||o}catch(e){return o}return o},proxyNames={get:["findOne","findAll","findById","findOrCreate","findAndCountAll","findAndCount","findCreateFind","count","max","min","sun"],post:["create","bulkCreate","update","destroy","increment","decrement"]};function parseSign(e,t,o,n){"function"==typeof t&&(t=t(n));let r=e.match(PATTERN_IDENTIFIER),i=r,a=t;if(r=r&&r[0],"string"==typeof t&&/^@/.test(t)&&(a=n[i=t.match(PATTERN_IDENTIFIER)[0]]),/^!/.test(e)&&null==n[i])return;let s={">":"gt",">=":"gte","<":"lt","<=":"lte","!=":"ne","=":"and",$and:"and",$or:"or",$gt:"gt",$gte:"gte",$lt:"lt",$lte:"lte",$ne:"ne",$eq:"eq",$not:"not",$between:"between",$notBetween:"notBetween",$in:"in",$notIn:"notIn",$like:"like",$notLike:"notLike",$iLike:"iLike",$regexp:"regexp",$iRegexp:"iRegexp",$notIRegexp:"notIRegexp",$overlap:"overlap",$contains:"contains",$contained:"contained",$any:"any",$col:"col"},l=e.match(new RegExp("("+Object.keys(s).map(e=>escapeStringRegexp(e)).join("|")+")")),c=s[l?l[0]:"="];"and"===c?(o[r]||(o[r]=[]),o[r]=a):(o[r]||(o[r]={}),o[r][c]=a)}const maps={};function add(e,t){return"function"!=typeof t&&(t=(()=>t)),maps[e]=t.bind(maps),this}function remove(e){return delete maps[e]}function get(e){return maps[e]}function create(...e){return function e(t,o=[]){for(let n in t){let r=t[n];if("string"==typeof r)o.push(maps[r]());else if(Array.isArray(r))e(r,o);else{let[t,n]=Object.entries(r)[0],i=maps[t]();i.include=[],o.push(i),e(n,i.include)}}return{include:o}}(e)}var Include={add:add,remove:remove,get:get,create:create};let where=(...e)=>t=>getOp(e,t),pagination=(e=5,t=0)=>o=>{const n=~~o.count||e;return{limit:n,offset:(~~o.page||t)*n}},fuzzyQuery=(e="name")=>where([`${e} $like`,t=>`%${t[e]}%`]),fuzzyQueryLeft=(e="name")=>where([`${e} $like`,t=>`%${t[e]}`]),fuzzyQueryRight=(e="name")=>where([`${e} $like`,t=>`${t[e]}%`]),include=(...e)=>t=>({include:e}),order=(...e)=>t=>({order:e}),remove$1=(...e)=>t=>{for(let o in e)t.hasOwnProperty(o)&&delete t[o];return{}},set=(e,t)=>o=>(o[e]=t,{}),merge$1=(...e)=>t=>merge.recursive(!0,{},...e.map(e=>"function"==typeof e?e(t):e));function wrapper(e){return Array.isArray(e)?e:[e]}let it=(e,t,o=noop)=>n=>("boolean"==typeof e?e:"function"==typeof e?e(n):n[e])?merge$1(...wrapper(t))(n):merge$1(...wrapper(o))(n),not=(e,t,o=noop)=>it(e,o,t),itField=(e,t)=>o=>{const n=o[e];return it(!0,t[n])(o)};var Scopes={where:where,fuzzyQuery:fuzzyQuery,fuzzyQueryLeft:fuzzyQueryLeft,fuzzyQueryRight:fuzzyQueryRight,include:include,order:order,pagination:pagination,remove:remove$1,set:set,it:it,itField:itField,not:not,merge:merge$1};function Handle(e,t={}){if(!(this instanceof Handle))return new Handle(e,t={});this.model=e,this.options=t,this.defaultScopes=[],this._data=null,this.__reset()}function method(e="get"){return e=e.toLowerCase(),requestMethods.includes(e)||error("Only the http standard request method is supported ("+requestMethods.join("/")+")",e),this._opts.method=e,this}function raw(e){return this._opts.rawData=e,this}function scope(...e){return e.forEach(e=>{isObj(e)||"function"==typeof e||error("Scope must be a function or object.",`${this.model.name}.scope(→...scopes←)`),this._opts.scopes.push(e)}),this}function defaultScope(...e){return e.forEach(e=>{isObj(e)||"function"==typeof e||error("Scope must be a function or object.",`${this.model.name}.scope(→...scopes←)`),this.defaultScopes.push(e)}),this}function rawScope(...e){return new Handle(this.model.scope(...e),this.options)}function process$1(e,t){return"function"==typeof e&&([t,e]=[e,"get"]),requestMethods.includes(e)||error("Only the http standard request method is supported ("+requestMethods.join("/")+")",e),async(o,n)=>{let r=getRequestData(e,o);try{r=this.__callHook("before",r,o,n),this._data=r;let e=await t.call(this,r,o,n);return this._data=null,e=this.__callHook("after",e,o,n),o.body=this.__callHook("data",null,e,o,n)}catch(e){return o.body=this.__callHook("data",e,null,o,n)}}}function transaction(e,t){return this.process(e,async function(e,o,n){return await this.model.sequelize.transaction(r=>t.call(this,e,o,n,r))})}function mock(e){const t=this.options.mock;return t||error("Handle.prototype.mock 方法依赖 mock 库，推荐使用 mockjs\n npm install mockjs --save\n 然后，在 Handle.options.mock = Mock 使用指定的 mock 库"),this.raw(t.mock(e).data).bulkCreate()}function __internal(e,...t){let{defaultScopes:o}=this,{method:n,rawData:r,scopes:i}=this.__reset();return async(a,s)=>{const l=n||tailspin(this,`options.proxy${e}.method`)||tailspin(Handle,`defaults.proxy${e}.method`)||"get";let c=getRequestData(l,a);try{c=this.__callHook("before",c,a,s);let n=getOp(t,c);n=mixinScope(c,n,o,i),r&&(c="function"==typeof r?r(c):r),n=[c,n].slice(-this.model[e].length);let l=await this.model[e](...n);return l=this.__callHook("after",l,a,s),a.body=this.__callHook("data",null,l,a,s)}catch(e){return a.body=this.__callHook("data",e,a,s)}}}async function __process(e,...t){let{defaultScopes:o}=this,{rawData:n,scopes:r}=this.__reset(),i=this._data,a=getOp(t,i);return a=mixinScope(i,a,o,r),n&&(i="function"==typeof n?n(i):n),console.log(a),a=[i,a].slice(-this.model[e].length),await this.model[e](...a)}function __reset(){let e=this._opts;return this._opts={scopes:[]},e&&(e=merge.recursive(!0,{},e)),e}function __callHook(e,...t){const o=this.options[e];return o&&"function"==typeof o?o(...t):3===t.length?t[0]:t[1]}Handle.prototype={constructor:Handle,method:method,raw:raw,scope:scope,defaultScope:defaultScope,rawScope:rawScope,process:process$1,transaction:transaction,mock:mock,__internal:__internal,__process:__process,__reset:__reset,__callHook:__callHook},Handle.defaults={proxy:{}};for(let e in proxyNames){proxyNames[e].forEach(t=>{Handle.defaults.proxy[t]={method:e},Handle.prototype[t]=function(...e){return this.__internal(t,...e)},Handle.prototype["raw"+initialCap(t)]=function(...e){return this.__process(t,...e)}})}Handle.load=load,Handle.loadAll=loadAll,Handle.Include=Include,Handle.Scopes=Scopes,module.exports=Handle;
