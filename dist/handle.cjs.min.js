"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var _merge=_interopDefault(require("merge"));let getOp=(e,t,r,o)=>("string"==typeof e&&(e=[e]),Array.isArray(e)?{where:e.reduce((e,r)=>("string"==typeof r?e[r]=t[r]:Array.isArray(r)&&(e[r[0]]=/^@/.test(r[1])?t[r[1].slice(1)]:r[1]),e),{})}:"function"==typeof e?e(t,r,o):e||{}),getRequestData=(e,t)=>"get"===e?t.query:"post"===e?t.request.body:{},mixinScope=(e,t,r,o)=>{let n=r.concat(o);if(!n.length)return t;let i=n.map(t=>{let r="function"==typeof t?t(e):t;return"function"==typeof r&&(r=t()(e)),r});return _merge.recursive(!0,t,...i)},initialCap=e=>e[0].toUpperCase()+e.substring(1),proxyNames={get:["findOne","findAll","findById","findOrCreate","findAndCountAll","findAndCount","findCreateFind","count","max","min","sun"],post:["create","bulkCreate","update","destroy","increment","decrement"]};class Include{constructor(){this.__maps={}}add(e,t){const r=this.__maps;return"function"!=typeof t&&(t=(()=>t)),r[e]=t.bind(r),this}remove(e){return delete this.__maps[e]}get(e){return this.__maps[e]}create(...e){const t=this.__maps;return function e(r,o=[]){for(let n in r){let i=r[n];if("string"==typeof i)o.push(t[i]());else if(Array.isArray(i))e(i,o);else{let[r,n]=Object.entries(i)[0],s=t[r]();s.include=[],o.push(s),e(n,s.include)}}return{include:o}}(e)}}let isObject=e=>"[object Object]"===Object.prototype.toString.call(e),toPairs=e=>[...Object.entries(e)],noop=()=>{};function superNormalize(e,t,r){if("string"==typeof t&&(t=[t]),isObject(t[0])&&(t=toPairs(t[0])),Array.isArray(t))return t.reduce((t,o,n)=>{let i,s;return"string"==typeof o?s=e[i=o]:(i=o[0],s="@"===o[1][0]?e[o[1].slice(1)]:o[1]),r(s,i,n)&&(t[i]=s),t},{})}let z=e=>Array.isArray(e)?e:[e],m=(e,t)=>z(e).filter(e=>e=>"function"==typeof e).map(e=>e(t)),p=e=>t=>"string"==typeof t?e[t]:Array.isArray(t)?e[t[0]]===t[1]:void("function"==typeof t&&t(e)),it=(e,t=noop,r=noop)=>o=>_merge.recursive(!0,...z(e).every(p(o))?m(t,o):m(r,o)),option=(...e)=>t=>({where:superNormalize(t,e,e=>void 0!==e)}),where=(...e)=>t=>({where:superNormalize(t,e,e=>!0)}),fuzzyQueryRight=(e="name",t)=>(null==t&&(t=e),r=>r[t]&&{where:{[e]:{like:`${r[t]}%`}}}),fuzzyQueryLeft=(e="name",t)=>(null==t&&(t=e),r=>r[t]&&{where:{[e]:{like:`%${r[t]}`}}}),fuzzyQuery=(e="name",t)=>(null==t&&(t=e),r=>r[t]&&{where:{[e]:{like:`%${r[t]}%`}}}),pagination=(e=5,t=0)=>r=>{const o=~~r.count||e;return{limit:o,offset:(~~r.page||t)*o}},includes=(...e)=>t=>({include:e}),order=e=>t=>({order:e}),merge=(...e)=>t=>_merge.recursive(!0,t,...e.map(e=>"function"==typeof e?e(t):e)),set=(...e)=>t=>Object.assign(t,superNormalize(t,e,e=>null!=e)),del=(...e)=>t=>e.forEach(e=>e in t&&delete t[e]);var Scopes={it:it,option:option,where:where,fuzzyQuery:fuzzyQuery,fuzzyQueryLeft:fuzzyQueryLeft,fuzzyQueryRight:fuzzyQueryRight,order:order,includes:includes,pagination:pagination,merge:merge,set:set,del:del};class Handle{constructor(e,t={}){this.model=e,this.options=t,this._scopes=[],this._defaultScopes=[],this._data=null}scope(...e){return this.__clearScope(),e.forEach(e=>this._scopes.push(e)),this}__clearScope(){const e=this._scopes;return this._scopes=[],e}defaultScope(...e){return e.forEach(e=>this._defaultScopes.push(e)),this}rawScope(...e){return new Handle(this.model.scope(...e),this.options)}process(e,t){return"function"==typeof e&&([t,e]=[e,"get"]),async(r,o)=>{let n=getRequestData(e,r);try{n=this.__callHook("before",n,r,o),this._data=n;let e=await t.call(this,n,r,o);return this._data=null,e=this.__callHook("after",e,r,o),r.body=this.__callHook("data",e,r,o)}catch(e){return r.body=this.__callHook("data",e,r,o)}}}transaction(e,t){return this.process(e,async function(e,r,o){return await this.model.sequelize.transaction(n=>t.call(this,e,r,o,n))})}mock(e){const t=this.options.mock;if(!t)throw new Error("Handle.prototype.mock 方法依赖 mock 库，推荐使用 mockjs\n npm install mockjs --save\n 然后，在 Handle.options.mock = Mock 使用指定的 mock 库");return this.bulkCreate(t.mock(e).data,{})}__internal(e,t,r,o,n){return null==n&&([o,n]=[void 0,o]),async(i,s)=>{let a=getRequestData(e,i);try{a=this.__callHook("before",a,i,s);let e=getOp(n,a,i,s);e=mixinScope(a,e,this._defaultScopes,r),e=[o||a,e].slice(-this.model[t].length);let l=await this.model[t](...e);return l=this.__callHook("after",l,i,s),i.body=this.__callHook("data",l,i,s)}catch(e){return i.body=this.__callHook("data",e,i,s)}}}async __process(e,t,r,o){null==o&&([r,o]=[void 0,r]);let n=this._data,i=getOp(o,n);return i=[r||n,i=mixinScope(n,i,this._defaultScopes,t)].slice(-this.model[e].length),await this.model[e](...i)}__callHook(e,t,r,o){const n=this.options[e];return n&&"function"==typeof n?n(t,r,o):t}}for(let e in proxyNames){proxyNames[e].forEach(t=>{Handle.prototype[t]=function(...r){return this.__internal(e,t,this.__clearScope(),...r)},Handle.prototype["raw"+initialCap(t)]=function(...e){return this.__process(t,this.__clearScope(),...e)}})}Handle.Include=new Include,Handle.Scopes=Scopes,module.exports=Handle;
