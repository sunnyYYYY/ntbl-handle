import merge from"merge";import path from"path";import chalk from"chalk";import escapeStringRegexp from"escape-string-regexp";import glob from"glob";import Mock from"mockjs";const PATTERN_IDENTIFIER=/[A-Za-z_][A-Za-z0-9_]*/;let requestMethods=["get","head","put","delete","post","options"],isObj=e=>"[object Object]"===Object.prototype.toString.call(e),noop=()=>{},error=(e,t="")=>{console.error(chalk.bgRed(" ERROR ")+" "+chalk.red(e)+(t?" ☞ "+chalk.gray(t):"")),process.exit(1)},load=(e,t,o)=>{"string"!=typeof t&&error("dir must be a string.","load(sequelize, →dir←, options)");try{return new Handle(e.import(t),o)}catch(e){1===load.length&&error("You may not have passed in the Sequelie instance, it imports the model using import."),error(e)}},loadAll=function(e,t,o={}){"string"!=typeof t&&error("dir must be a string.","load(sequelize, →dir←, options)");const{rule:r="/**/!(index|_)*.js"}=o;return glob.sync(path.join(t,r)).reduce((t,r)=>{const n=path.parse(r).name;return t[n]=this.load(e,r,o),t["_"+n]=t[n].model,t},{})},getOp=(e,t)=>{if("string"==typeof e)e=[e];else if("function"==typeof e)return e(t);return Array.isArray(e)?{where:e.reduce((e,o)=>("string"==typeof o?parseSign(o,"@"+o,e,t):Array.isArray(o)&&parseSign(o[0],o[1],e,t),e),{})}:e||{}},getRequestData=(e,t)=>"get"===(e=e.toLowerCase())?t.query:"post"===e?t.request.body:{},mixinScope=(e,t,o,r)=>{let n=o.concat(r);if(!n.length)return t;let i=n.map(t=>{if(isObj(t))return t;let o=t(e);return o="function"==typeof o?t()(e):t(e)});return merge.recursive(!0,t,...i)},initialCap=e=>e[0].toUpperCase()+e.substring(1),tailspin=(e,t,o)=>{const r=t.match(/[^\.\[\]]+/g);if(r)try{return r.map(e=>Object.is(Number(e),NaN)?e:Number(e)).reduce((e,t)=>e[t],e)||o}catch(e){return o}return o},proxyNames={get:["findOne","findAll","findById","findOrCreate","findAndCountAll","findAndCount","findCreateFind","count","max","min","sun"],post:["create","bulkCreate","update","destroy","increment","decrement"]};function parseSign(e,t,o,r){"function"==typeof t&&(t=t(r));let n=e.match(PATTERN_IDENTIFIER),i=n,s=t;if(n=n&&n[0],"string"==typeof t&&/^@/.test(t)&&(s=r[i=t.match(PATTERN_IDENTIFIER)[0]]),/^!/.test(e)&&null==r[i])return;let a={">":"gt",">=":"gte","<":"lt","<=":"lte","!=":"ne","=":"and",$and:"and",$or:"or",$gt:"gt",$gte:"gte",$lt:"lt",$lte:"lte",$ne:"ne",$eq:"eq",$not:"not",$between:"between",$notBetween:"notBetween",$in:"in",$notIn:"notIn",$like:"like",$notLike:"notLike",$iLike:"iLike",$regexp:"regexp",$iRegexp:"iRegexp",$notIRegexp:"notIRegexp",$overlap:"overlap",$contains:"contains",$contained:"contained",$any:"any",$col:"col"},l=e.match(new RegExp("("+Object.keys(a).map(e=>escapeStringRegexp(e)).join("|")+")")),c=a[l?l[0]:"="];"and"===c?(o[n]||(o[n]=[]),o[n]=s):(o[n]||(o[n]={}),o[n][c]=s)}const maps={};function add(e,t){return"function"!=typeof t&&(t=(()=>t)),maps[e]=t.bind(maps),this}function remove(e){return delete maps[e]}function get(e){return maps[e]}function create(...e){return function e(t,o=[]){for(let r in t){let n=t[r];if("string"==typeof n)o.push(maps[n]());else if(Array.isArray(n))e(n,o);else{let[t,r]=Object.entries(n)[0],i=maps[t]();i.include=[],o.push(i),e(r,i.include)}}return{include:o}}(e)}var Include={add:add,remove:remove,get:get,create:create};let where=(...e)=>t=>getOp(e,t),pagination=(e=5,t=0)=>o=>{const r=~~o.count||e;return{limit:r,offset:(~~o.page||t)*r}},fuzzyQuery=(e="name")=>where([`${e} $like`,t=>`%${t[e]}%`]),fuzzyQueryLeft=(e="name")=>where([`${e} $like`,t=>`%${t[e]}`]),fuzzyQueryRight=(e="name")=>where([`${e} $like`,t=>`${t[e]}%`]),include=(...e)=>t=>({include:e}),order=(...e)=>t=>({order:e}),remove$1=(...e)=>t=>(e.forEach(e=>{e in t&&delete t[e]}),{}),set=(e,t)=>o=>(o[e]=t,{}),merge$1=(...e)=>t=>merge.recursive(!0,{},...e.map(e=>"function"==typeof e?e(t):e));function wrapper(e){return Array.isArray(e)?e:[e]}let it=(e,t,o=noop)=>r=>("boolean"==typeof e?e:"function"==typeof e?e(r):r[e])?merge$1(...wrapper(t))(r):merge$1(...wrapper(o))(r),not=(e,t,o=noop)=>it(e,o,t),itField=(e,t)=>o=>{const r=o[e];return it(!0,t[r])(o)};var Scopes={where:where,fuzzyQuery:fuzzyQuery,fuzzyQueryLeft:fuzzyQueryLeft,fuzzyQueryRight:fuzzyQueryRight,include:include,order:order,pagination:pagination,remove:remove$1,set:set,it:it,itField:itField,not:not,merge:merge$1};function Handle(e,t={}){if(!(this instanceof Handle))return new Handle(e,t={});this.model=e,this.options=t,this.defaultScopes=[],this._data=null,this.__reset()}function method(e="get"){return e=e.toLowerCase(),requestMethods.includes(e)||error("Only the http standard request method is supported ("+requestMethods.join("/")+")",e),this._opts.method=e,this}function raw(e){return this._opts.rawData=e,this}function scope(...e){return e.forEach(e=>{isObj(e)||"function"==typeof e||error("Scope must be a function or object.",`${this.model.name}.scope(→...scopes←)`),this._opts.scopes.push(e)}),this}function defaultScope(...e){return e.forEach(e=>{isObj(e)||"function"==typeof e||error("Scope must be a function or object.",`${this.model.name}.scope(→...scopes←)`),this.defaultScopes.push(e)}),this}function rawScope(...e){return new Handle(this.model.scope(...e),this.options)}function process$1(e,t){return"function"==typeof e&&([t,e]=[e,"get"]),requestMethods.includes(e)||error("Only the http standard request method is supported ("+requestMethods.join("/")+")",e),async(o,r)=>{let n=getRequestData(e,o);try{n=this.__callHook("before",n,o,r),this._data=n;let e=await t.call(this,n,o,r);return this._data=null,e=this.__callHook("after",e,o,r),o.body=this.__callHook("data",null,e,o,r)}catch(e){return o.body=this.__callHook("data",e,null,o,r)}}}function transaction(e,t){return this.process(e,async function(e,o,r){return await this.model.sequelize.transaction(n=>t.call(this,e,o,r,n))})}function mock(e,t){return isObj(e)&&([e,t]=[1,e]),this.raw(Mock.mock({[`data|${e}`]:[t]}).data).bulkCreate()}function __internal(e,...t){let{defaultScopes:o}=this,{method:r,rawData:n,scopes:i}=this.__reset();return async(s,a)=>{const l=r||tailspin(this,`options.proxy.${e}.method`)||tailspin(Handle,`defaults.proxy.${e}.method`)||"get";let c=getRequestData(l,s);try{c=this.__callHook("before",c,s,a);let r=getOp(t,c);r=mixinScope(c,r,o,i),n&&(c="function"==typeof n?n(c):n),r=[c,r].slice(-this.model[e].length);let l=await this.model[e](...r);return l=this.__callHook("after",l,s,a),s.body=this.__callHook("data",null,l,s,a)}catch(e){return s.body=this.__callHook("data",e,s,a)}}}async function __process(e,...t){let{defaultScopes:o}=this,{rawData:r,scopes:n}=this.__reset(),i=this._data,s=getOp(t,i);return s=mixinScope(i,s,o,n),r&&(i="function"==typeof r?r(i):r),console.log(s),s=[i,s].slice(-this.model[e].length),await this.model[e](...s)}function __reset(){let e=this._opts;return this._opts={scopes:[]},e&&(e=merge.recursive(!0,{},e)),e}function __callHook(e,...t){const o=this.options[e];return o&&"function"==typeof o?o(...t):3===t.length?t[0]:t[1]}Handle.prototype={constructor:Handle,method:method,raw:raw,scope:scope,defaultScope:defaultScope,rawScope:rawScope,process:process$1,transaction:transaction,mock:mock,__internal:__internal,__process:__process,__reset:__reset,__callHook:__callHook},Handle.defaults={proxy:{}};for(let e in proxyNames){proxyNames[e].forEach(t=>{Handle.defaults.proxy[t]={method:e},Handle.prototype[t]=function(...e){return this.__internal(t,...e)},Handle.prototype["raw"+initialCap(t)]=function(...e){return this.__process(t,...e)}})}Handle.load=load,Handle.loadAll=loadAll,Handle.Include=Include,Handle.Scopes=Scopes;export default Handle;
