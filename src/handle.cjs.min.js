"use strict";function _interopDefault(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var merge=_interopDefault(require("merge"));let getOp=(t,e,s,n)=>("string"==typeof t&&(t=[t]),Array.isArray(t)?{where:t.reduce((t,s)=>("string"==typeof s&&(t[s]=e[s]),Array.isArray(s)&&(t[s[0]]=/^@/.test(s[1])?e[s[1].slice(1)]:s[1]),t),{})}:"function"==typeof t?t(e,s,n):t||{}),getRequestData=(t,e)=>"get"===t?e.query:"post"===t?e.request.body:{},mixinScope=(t,e,s,n)=>{let r=s.concat(n);if(!r.length)return e;let o=r.map(e=>{let s="function"==typeof e?e(t):e;return"function"==typeof s&&(s=e()(t)),s});return merge.recursive(!0,e,...o)},getProxyFunNames={get:["findOne","findAll","findById","findOrCreate","findAndCountAll","findAndCount","findCreateFind","count","max","min","sun"],post:["create","bulkCreate","update","destroy","increment","decrement"]};class Include{constructor(){this.__maps={}}add(t,e){const s=this.__maps;return"function"!=typeof e&&(e=(()=>e)),s[t]=e.bind(s),this}remove(t){return delete this.__maps[t]}get(t){return this.__maps[t]}create(...t){const e=this.__maps;return function t(s,n=[]){for(let r in s){let o=s[r];if("string"==typeof o)n.push(e[o]());else if(Array.isArray(o))t(o,n);else{let[s,r]=Object.entries(o)[0],i=e[s]();i.include=[],n.push(i),t(r,i.include)}}return n}(t)}}class Handle{constructor(t,e={}){this.model=t,this.options=e,this._defaultScopes=[],this._scopes=[],this._data={},this.__init(getProxyFunNames)}defaultScope(...t){return t.forEach(t=>this._defaultScopes.push(t)),this}scope(...t){return this._scopes=[],t.forEach(t=>this._scopes.push(t)),this}rawScope(...t){return new Handle(this.model.scope(...t),this.options)}process(t,e){"function"==typeof t&&(e=t,t="get");const{before:s,after:n,data:r}=this.options;return async(o,i)=>{let a=getRequestData(t,o);try{s&&s(a,o,i),this._data=a;let t=await e.call(this,a,o,i);return this._data={},n&&(t=n(t,o,i)),o.body=r(void 0,t,o,i)}catch(t){return o.body=r(t,null,o,i)}}}toggle(...t){return async(e,s)=>{await this.__base("post","findOne",...t)(e,s)?await this.__base("post","destroy",...t)(e,s):await this.__base("post","create",...t)(e,s)}}transaction(){}mock(t){const e=this.options.mock;if(!e)throw new Error("Handle.prototype.mock 方法依赖 mock 库，推荐使用 mockjs\n npm install mockjs --save\n 然后，在 Handle.options.mock = Mock 使用指定的 mock 库");return this.bulkCreate({},s=>e.mock(t).data)}__init(t){for(let e in t)t[e].forEach(t=>{Handle.prototype[t]=function(...s){return this.__base(e,t,...s)};const s="raw"+t[0].toUpperCase()+t.substring(1);Handle.prototype[s]=function(...e){return this.__processBase(t,...e)}})}__base(t,e,s,n,r){const{before:o,after:i,data:a}=this.options;return async(c,u)=>{let l=getRequestData(t,c);try{o&&(l=o(l,c,u)),n&&(l=n(l,c,u));let t=getOp(s,l,c,u);t=mixinScope(l,t,this._defaultScopes,this._scopes);const p=this.model[e];let d=p.length;t=1===d?[t]:2===d?[l,t]:[];let h=await p.apply(this.model,t);return i&&(h=i(h,c,u)),r&&(h=r(h,c,u)),c.body=a(void 0,h,c,u)}catch(t){return c.body=a(t,null,c,u)}}}async __processBase(t,e,s){s||(s=e,e=null);const n=this._data;let r=getOp(s,n);return r=mixinScope(n,r,this._defaultScopes,this._scopes),r=e?[e,r]:[r],await this.model[t](...r)}}Handle.Include=new Include,module.exports=Handle;
