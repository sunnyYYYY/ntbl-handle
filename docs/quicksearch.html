<html>
<head>
</head>
<body style="background: transparent;">
    <script src="scripts/docstrap.lib.js"></script>
    <script src="scripts/lunr.min.js"></script>
    <script src="scripts/fulltext-search.js"></script>

    <script type="text/x-docstrap-searchdb">
    {"classes.list.html":{"id":"classes.list.html","title":"Classes","body":" DocStrap Classes HandleInclude Classes Classes Handle Include × Search results Close Documentation generated by JSDoc 3.5.5 on 2018-08-11T10:32:04+08:00 using the DocStrap template. "},"index.html":{"id":"index.html","title":"Index","body":" DocStrap Classes HandleInclude Handle.jsHandle.js，一个基于 koa 和 sequelize 的中间库，让你只专注于接口逻辑。 api 文档。 Usage// 导入 sequelize 模型 import { article } from '../models/db' // 把 article 传入 Handle，并实例化 const article = new Handle(article) // 生成一个查询当前模型所有数据的 koa 中间件 const find = article.findAll() // 绑定到路由 router.get('/article/find', find)开始实例的模型方法一览Handle.js 代理了部分 sequelize 模型方法，以下： GET 请求 findOne findAll findById findOrCreate findAndCountAll findAndCount findCreateFind count max min sun POST 请求 create bulkCreate update destroy increment decrement 同时，Handle.js 还内置以下模型方法： POST 请求 toggle 以上所有模型方法统称为快捷方法，调用后生成一个 async 的 koa 中间件函数，可以直接挂载路由。此外，还提供了一套对应的过程方法，调用后仅返回原生数据，可供进一步处理。以下： GET 请求 rawFindOne rawFindAll rawFindById rawFindOrCreate rawFindAndCountAll rawFindAndCount rawFindCreateFind rawCount rawMax rawMin rawSun POST 请求 rawCreate rawBulkCreate rawUpdate rawDestroy rawIncrement rawDecrement rawToggle where 子句简写 字符串语法 article.findOne('id') // 内部将替换成 // { // where: { id: d.id } // } // GET 请求下，d 为 ctx.query 对象。POST 请求下，d 为 ctx.request.body 对象（默认为 x-www-form-urlencoded 类型）。 多条件 article.findOne(['id', 'uid']) // 内部将替换成 // { // where: { // id: d.id, // uid: d.uid // } // } // 提供默认值 article.findOne(['id', ['uid': 1]]) // 内部将替换成 // { // where: { // id: d.id, // uid: 1 // } // } // 别名 article.findOne([['id', '@aid'], ['uid', 1]]) // 内部将替换成 // { // where: { // id: d.aid, // uid: 1 // } // } //更强大的函数式函数式下支持所有 sequelize 模型选项中合法的选项。（具体请参考 Model） article.findOne(d =&gt; ({ where: { id: d.aid, uid: 1 }, }))更复杂的分页查询。 article.findAll(d =&gt; { const count = d.count || 5 const page = d.page || 0 return { where: { uid: d.uid }, limit: count, offset: page * count } }),原生数据create() 将自动把 d 作为数据增加到数据库中。 article.create()但是，对于 increment() 你可能只想增加某个字段的值，你可以直接指定原生数据。 article.increment('comment_count', 'id')注意，原生数据在内部不会做任何处理。 选项对象请参考 API 手册 过程process 将一系列操作封装到一起，提供了可以验证、过滤、重组等处理数据的能力，并且非常适合非事务性的多次数据库操作等场景。通常，需要配合过程方法使用。 // 查询用户收藏的文章 articleStar.process(async function (d) { const {count = 5, page = 0, uid} = d const res = await this.rawFindAll({ include: [ { // 关联查询文章数据 model: Article, // 并且查询文章的用户数据 include: [User] } ], // 通过 uid 查询 where: { uid }, // 分页 limit: count, offset: page * count }) // 过滤数据，仅返回文章数据 return res &amp;&amp; res.map(d =&gt; d.article) })另外，当出现一些重复逻辑时，你也可以很方便的提取出来复用。 作用域scope 是复用模型选项对象的最佳选择，它在内部使用了 merge 深度混合所有 scope 到选项对象中。外在而言，让你的代码更直观、简洁、易懂和良好的复用性，更易于重构和修改。 把上面的分页逻辑封装成为一个 提供参数的 scope。 function pagination (defaultCount = 5, defaultPage = 0) =&gt; { return d =&gt; { const count = d.count || defaultCount const page = d.page || defaultPage return { limit: count, offset: page * count } } }然后，通过 scope() 方法到处复用。 // 查询所有指定 uid 的数据，且每页返回 10 条数据 article.scope(pagination(10)).findAll('uid') // 使用 pagination 函数提供默认值 article.scope(pagination()).findAll('uid') // 其实，你可以省略掉 pagination 前面的 () article.scope(pagination).findAll('uid') // 同时，scope 还可以是对象 articleStar.process(async function (d) { const include = { include: [ { model: Article, include: [User] } ], } const res = await this .scope(pagination, include) .rawFindAll('uid') return res &amp;&amp; res.map(d =&gt; d.article) }),scope() 方法合并的选项对象仅在第一次被使用的方法上有效。如果，想要让所有当前实例的模型方法都共享某些 scope ，可以通过 defaultScope() 添加。注意，每个 scope 都必须最终返回一个选项对象。 关联查询Include 是 Handle.js 一个静态工具类，用于统一管理整个应用的关联数据。 const { Include } = Handle Include // 添加名为 article 的关联，并忽略查询一些属性。 .add('article', { model: Article, attributes: { exclude: ['content', 'createdAt', 'updateAt'] }, }) // 同时添加一个名为 user 的关联。 .add('user', { model: User, attributes: { exclude: ['password', 'lock', 'freeze', 'power' ,'createdAt', 'updateAt'] }, })然后，通过 Handle.create() 方法，可以简单的组合已添加关联的层级关系。 articleStar.process(async function (d) { const res = await this .scope(pagination, Include.create({ article: ['user'] })) .rawFindAll('uid') return res &amp;&amp; res.map(d =&gt; d.article) }),Handle 在可高度复用关联数据的同时，又能以最小化、最简单的方式组织和管理。 事务transaction 是通过 process 简单的对 sequelize 原生事务的封装。在使用上，和 process 完全一致。 articleStar.transaction(async function (d) { /** 事务相关的处理 */ return /** 返回处理后的数据 */ }),钩子（暂无） Mock 支持Handle.js 提供了 mock 的接口，但它依赖于 mock 库。这里，我推荐使用 mockjs。 首先，你需要通过选项对象传入 mock 库以开启 mock() 方法 import Mock from 'mockjs' // 指定要使用 mockjs const article = new Handle(Article) article.options.mock = Mock然后，使用实例的 mock() 方法。 // 批量向 article 表中插入 20 条数据 article.mock({ 'data|20': [ { title: '@ctitle', content: '@cparagraph' } ] })mock() 内部调用实例的 bulkCreate() 方法批量添加数据（注意，因为使用了原生数据入口，所以不会对数据做任何处理） 一些差异性的问题（敬请期待） 插件系统（暂无） × Search results Close Documentation generated by JSDoc 3.5.5 on 2018-08-11T10:32:04+08:00 using the DocStrap template. "},"Handle.html":{"id":"Handle.html","title":"Class: Handle","body":" DocStrap Classes HandleInclude Class: Handle Handle Handle.js， 一个基于 koa 和 sequelize 的中间库, 让你只专注于接口逻辑。 new Handle(model [, options]) Parameters: Name Type Argument Default Description model Model sequelize 的模型实例 options object &lt;optional&gt; {} 选项对象 Properties Name Type Argument Default Description mock Mock &lt;optional&gt; null mock 库，以启用 Handle.prototype.mock 方法 before(data, ctx, next) function &lt;optional&gt; 全局钩子。before 钩子在数据库操作之前执行。（注意，全局钩子 before 与快捷方法的 before 函数行为一致，但 before 函数在 全局钩子 before 之后调用，可能会发生覆盖。） after(result, ctx, next) function &lt;optional&gt; 全局钩子。 after 钩子在数据库操作之后执行（注意，情况和全局钩子 before 相同） data(err, data, ctx, next) function &lt;optional&gt; 全局钩子。data 钩子可以在返回数据到前端之前和捕获异常之后做一些处理。 Members &lt;static&gt; Include :Include 关联生成器 Type: Include Since: 1.0.0 See: Include Methods defaultScope(scopes) 组合一个或多个实例作用域（作用于实例的每个方法） Parameters: Name Type Argument Description scopes object | function &lt;repeatable&gt; 作用域 Since: 1.0.0 See: scope rawScope Returns: Type Handle mock(rule) 向数据库中批量插入由 mock 生成的随机数据 Parameters: Name Type Description rule object mock 的生成规则 Since: 1.0.0 Returns: Type * Example // 生成 10 条数据（mockjs 为例） h.mock({ 'data|10': [ { title: '@ctitle', content: '@cparagraph', } ] }) process( [method], f(data,ctx,next)) 启用一个过程 Parameters: Name Type Argument Default Description method string &lt;optional&gt; 'get' 请求方法 f(data,ctx,next) asyncFunction 一个 async/await 函数 Since: 1.0.0 Returns: Type function rawScope(scopes) 组合一个或多个 sequelize 作用域（一层简单的封装） Parameters: Name Type Argument Description scopes object | function &lt;repeatable&gt; 要组合的作用域名 Since: 1.0.0 See: defaultScope scope Returns: Type Handle &lt;async&gt; rawToggle(args) 查询数据是否存在，存在则删除，不存在则创建 Parameters: Name Type Argument Description args &lt;repeatable&gt; Returns: Type Promise.&lt;*&gt; scope(scopes) 组合一个或多个方法作用域（仅作用于接下来第一次使用的方法） Parameters: Name Type Argument Description scopes object | function &lt;repeatable&gt; 作用域 Since: 1.0.0 See: defaultScope rawScope Returns: Type Handle toggle(args) 查询数据是否存在，存在则删除，不存在则创建 Parameters: Name Type Argument Description args &lt;repeatable&gt; Returns: Type function transaction( [method], f(data,ctx,next,) 启用一个事务 Parameters: Name Type Argument Default Description method string &lt;optional&gt; 'get' 请求方法 f(data,ctx,next, asyncFunction t) - 一个 async/await 函数 Since: 1.0.0 Returns: Type function × Search results Close Documentation generated by JSDoc 3.5.5 on 2018-08-11T10:32:04+08:00 using the DocStrap template. "},"Include.html":{"id":"Include.html","title":"Class: Include","body":" DocStrap Classes HandleInclude Class: Include Include 关联查询的辅助类， 通过 add 添加模型的基本 include，然后由 create 指定层级关系，并生成复杂的关联查询。 new Include() Methods add(name, f) 添加一个 include Parameters: Name Type Description name string include 的名称 f object | function 一个返回 include 数据的方法，如果为对象，则简单的封装成一个函数 Returns: Type Include create(scopes) 组合 include 生成更复杂的 include Parameters: Name Type Argument Description scopes args &lt;repeatable&gt; 指定的层级关系 Returns: Type Array get(name) 获取一个 include Parameters: Name Type Description name string include 的名称 Returns: Type * remove(name) 移除一个 include Parameters: Name Type Description name string include 的名称 Returns: Type boolean × Search results Close Documentation generated by JSDoc 3.5.5 on 2018-08-11T10:32:04+08:00 using the DocStrap template. "}}
    </script>

    <script type="text/javascript">
        $(document).ready(function() {
            Searcher.init();
        });

        $(window).on("message", function(msg) {
            var msgData = msg.originalEvent.data;

            if (msgData.msgid != "docstrap.quicksearch.start") {
                return;
            }

            var results = Searcher.search(msgData.searchTerms);

            window.parent.postMessage({"results": results, "msgid": "docstrap.quicksearch.done"}, "*");
        });
    </script>
</body>
</html>
